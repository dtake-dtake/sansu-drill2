<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>算数ドリルアプリ 目次</title>
  <style>
    body{font-family:sans-serif;margin:20px;background:#e0f7fa;}
    h1{text-align:center;margin-bottom:8px;}

    /* ───── フィルター UI ───── */
    #controls{display:flex;justify-content:center;margin-bottom:12px;}
    #controls select,#controls input{margin:0 4px;padding:6px;border:1px solid #ccc;border-radius:4px;}
    #search{width:240px;}

    /* ───── テーブル ───── */
    table{width:100%;background:#fff;border-collapse:collapse;margin-top:8px;}
    th,td{border:1px solid #ccc;padding:8px;text-align:center;white-space:nowrap;}
    th{background:#f5f5f5;cursor:pointer;position:relative;}
    th.sorted-asc{background:#b2ebf2;}
    th.sorted-desc{background:#ffe0b2;}
    th.no-sort{cursor:default;}
    tr:hover{background:#fafafa;}
    a{color:blue;text-decoration:none;}
    a:hover{text-decoration:underline;}

    /* ───── ステータス（星） ───── */
    .status-stars{font-size:1.2rem;}
    .status-SS{background:linear-gradient(to right,red,orange,yellow,green,blue,indigo,violet);
               -webkit-background-clip:text;color:transparent;}
    .status-S {color:gold;}
    .status-A {color:silver;}
    .status-B {color:#cd7f32;}
    .status-C,.status-D{color:gray;}
  </style>
</head>
<body>
  <h1>算数ドリルアプリ</h1>

  <div id="controls">
    <select id="gradeFilter"></select>
    <select id="unitFilter"></select>
    <input type="text" id="search" placeholder="ドリル名で絞り込み">
  </div>

  <table id="tocTable">
    <thead>
      <tr>
        <th data-key="grade">学年</th>
        <th data-key="unit">単元</th>
        <th data-key="no">No.</th>
        <th class="no-sort">名前</th>
        <th data-key="status">ステータス</th>
        <th data-key="dt">最終チャレンジ</th>
        <th data-key="hs">ハイスコア</th>
        <th data-key="clearsM">今月</th>
        <th data-key="clears">クリア回数</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    /* ===== ここだけ変えれば読み込む JSON を増やせる ===== */
    const JSON_FILES = [
      //'data/drills.json',      // 既存ファイル
      //'data/drills_extra.json' // 追加したいファイル（例）
      'grade2/○の段（じゅん）/drills_jun.json'
      'grade2/○の段（ばら）/drills_bara.json'
    ];

    /* ===== ステータス変換テーブル ===== */
    const statusOrder    = {SS:6,S:5,A:4,B:3,C:2,D:1,'―':0};
    const statusStarsMap = {
      SS:{stars:'★★★★★',cls:'status-SS'},
      S :{stars:'★★★★', cls:'status-S' },
      A :{stars:'★★★',  cls:'status-A' },
      B :{stars:'★★',   cls:'status-B' },
      C :{stars:'★',    cls:'status-C' },
      D :{stars:'ー',     cls:'status-D' },
      '―':{stars:'',    cls:''}
    };

    /* ===== データロード ===== */
    async function loadDrills(){
      // 複数 JSON を並列ロード → 1 つの配列へ fl at
      const lists = await Promise.all(
        JSON_FILES.map(async f => {
          try{
            const r = await fetch(f);
            if(!r.ok) throw new Error(r.status);
            return await r.json();
          }catch(e){ console.warn('Failed to load',f,e); return []; }
        })
      );
      return lists.flat();
    }

    /* ===== 月次キー ===== */
    const monthKeyOf = ns => ns + 'monthlyClear-' + new Date().toISOString().slice(0,7);

    /* ===== データ組み立て ===== */
    function buildListFromDrills(drills){
      return drills.map(d=>{
        const ls      = localStorage;
        const hs       = ls.getItem(d.ns+'highScore')  || '―';
        const clears   = ls.getItem(d.ns+'clearCount') || '0';
        const clearsM  = ls.getItem(monthKeyOf(d.ns))  || '0';
        let status='―', dt='―';
        try{
          const hist = JSON.parse(ls.getItem(d.ns+'history')||'[]');
          if(hist.length){ status = hist[0].status || status; dt = hist[0].datetime || dt; }
        }catch{}
        return {grade:d.grade,unit:d.unit??'',no:d.no??'',name:d.name,file:d.file,
                status,dt,hs,clears,clearsM};
      });
    }

    /* ===== フィルターリスト初期化 ===== */
    function initFilters(drills){
      const gradeSel=document.getElementById('gradeFilter');
      const unitSel =document.getElementById('unitFilter');
      const grades=[...new Set(drills.map(d=>d.grade))]
                     .sort((a,b)=>a.localeCompare(b,'ja',{numeric:true}));
      const units=[...new Set(drills.map(d=>String(d.unit??'')))]
                     .filter(v=>v!=='')
                     .sort((a,b)=>(+a)-(+b));
      gradeSel.innerHTML = '<option value="">学年</option>' +
                           grades.map(g=>`<option value="${g}">${g}</option>`).join('');
      unitSel.innerHTML  = '<option value="">単元</option>' +
                           units.map(u=>`<option value="${u}">${u}</option>`).join('');
    }

    /* ===== フィルター＆ソート ===== */
    let sort = {key:'grade',dir:null};
    function filterAndSort(data){
      const q  = document.getElementById('search').value.trim().toLowerCase();
      const gF = document.getElementById('gradeFilter').value;
      const uF = document.getElementById('unitFilter').value;
      let arr = data.filter(it=>
        (gF===''||it.grade===gF)&&
        (uF===''||String(it.unit)===uF)&&
        it.name.toLowerCase().includes(q)
      );
      if(!sort.dir) return arr;
      return arr.sort((a,b)=>{
        let cmp=0;
        switch(sort.key){
          case 'unit'   : cmp=(+a.unit||0)-(+b.unit||0);break;
          case 'no'     : cmp=(+a.no||0 )-(+b.no||0 );break;
          case 'hs':
          case 'clears':
          case 'clearsM': cmp=(+a[sort.key]||0)-(+b[sort.key]||0);break;
          case 'status' : cmp=statusOrder[a.status]-statusOrder[b.status];break;
          case 'dt'     : cmp=((a.dt==='―'?0:new Date(a.dt))-(b.dt==='―'?0:new Date(b.dt)));break;
          default       : cmp=a[sort.key].localeCompare(b[sort.key],'ja');
        }
        return sort.dir==='asc'?cmp:-cmp;
      });
    }

    /* ===== テーブル描画 ===== */
    let buildList=[];
    function renderTable(){
      const tbody=document.querySelector('#tocTable tbody'); tbody.innerHTML='';
      document.querySelectorAll('th[data-key]')
              .forEach(th=>th.classList.remove('sorted-asc','sorted-desc'));
      if(sort.dir){ const th=document.querySelector(`th[data-key="${sort.key}"]`);
        th.classList.add(sort.dir==='asc'?'sorted-asc':'sorted-desc'); }

      filterAndSort(buildList).forEach(it=>{
        const info=statusStarsMap[it.status]??{stars:it.status,cls:''};
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${it.grade}</td>
          <td>${it.unit}</td>
          <td>${it.no}</td>
          <td><a href="${it.file}" target="_blank">${it.name}</a></td>
          <td><span class="status-stars ${info.cls}">${info.stars}</span></td>
          <td>${it.dt}</td>
          <td>${it.hs}</td>
          <td>${it.clearsM}</td>
          <td>${it.clears}</td>`;
        tbody.appendChild(tr);
      });
    }

    /* ===== ソートハンドラ ===== */
    function attachSort(){
      document.querySelectorAll('th[data-key]').forEach(th=>{
        th.addEventListener('click',()=>{
          const k=th.dataset.key;
          if(sort.key===k && sort.dir){ sort.dir = sort.dir==='asc'?'desc':'asc'; }
          else { sort.key=k; sort.dir='desc'; }
          renderTable();
        });
      });
    }

    /* ===== 起動 ===== */
    window.onload=async()=>{
      const drills = await loadDrills();
      buildList    = buildListFromDrills(drills);
      initFilters(drills);
      attachSort();
      document.getElementById('search').addEventListener('input',renderTable);
      document.getElementById('gradeFilter').addEventListener('change',renderTable);
      document.getElementById('unitFilter').addEventListener('change',renderTable);
      renderTable();
    };
  </script>
</body>
</html>
