<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>算数学習アプリ 目次</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      background: #e0f7fa;
    }
    h1, p {
      text-align: center;
      margin-bottom: 12px;
    }
    table {
      width: 100%;
      background: #fff;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      white-space: nowrap;
    }
    th {
      background: #f5f5f5;
      cursor: pointer;
    }
    a {
      color: inherit;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <h1>算数学習アプリ</h1>
  <p>以下のドリルを選んでください。</p>

  <table id="tocTable">
    <thead>
      <tr>
        <th data-key="grade">学年</th>
        <th data-key="category">カテゴリ</th>
        <th data-key="name">名前</th>
        <th data-key="status">ステータス</th>
        <th data-key="dt">最終チャレンジ</th>
        <th data-key="hs">ハイスコア</th>
        <th data-key="clears">クリア回数</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // ------------------------------------------------------------
    // 1) drills.json を読み込み、配列 buildList を生成
    // ------------------------------------------------------------
    async function loadDrills() {
      try {
        const resp = await fetch('data/drills.json');
        if (!resp.ok) throw new Error('drills.json の読み込みに失敗: ' + resp.status);
        return await resp.json();
      } catch (e) {
        console.error(e);
        return [];
      }
    }

    // ------------------------------------------------------------
    // 2) localStorage からハイスコア・履歴・クリア回数を取得して buildList を組み立て
    // ------------------------------------------------------------
    const statusOrder = { 'SS': 6, 'S': 5, 'A': 4, 'B': 3, 'C': 2, 'D': 1, '―': 0 };

    function buildListFromDrills(drills) {
      return drills.map(d => {
        const hs = localStorage.getItem(d.ns + 'highScore') || '―';
        const clears = localStorage.getItem(d.ns + 'clearCount') || '0';

        let status = '―', dt = '―';
        try {
          const histJSON = localStorage.getItem(d.ns + 'history') || '[]';
          const arr = JSON.parse(histJSON);
          if (arr.length > 0) {
            status = arr[0].status || status;
            dt = arr[0].datetime || dt;
          }
        } catch {
          // パースエラー等あればデフォルトのまま
        }

        return {
          grade:    d.grade,
          category: d.category,
          name:     d.name,
          file:     d.file,
          status,
          dt,
          hs,
          clears
        };
      });
    }

    // ------------------------------------------------------------
    // 3) ソートキー・向きの初期値
    // ------------------------------------------------------------
    let sort = { key: 'name', dir: null };

    // ------------------------------------------------------------
    // 4) ヘッダクリックでソート設定を切り替える
    // ------------------------------------------------------------
    function attachSortHandlers() {
      document.querySelectorAll('th[data-key]').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.getAttribute('data-key');
          if (sort.key === key && sort.dir) {
            sort.dir = (sort.dir === 'asc' ? 'desc' : 'asc');
          } else {
            sort.key = key;
            sort.dir = 'desc';
          }
          renderTable();
        });
      });
    }

    // ------------------------------------------------------------
    // 5) テーブル描画（sort.dir === null なら元の JSON 順）
    // ------------------------------------------------------------
    function renderTable() {
      let data;
      if (sort.dir === null) {
        data = [...buildList];
      } else {
        data = [...buildList].sort((a, b) => {
          let cmp = 0;
          // 数値比較が必要な列
          if (sort.key === 'hs' || sort.key === 'clears') {
            cmp = (+a[sort.key] || 0) - (+b[sort.key] || 0);
          } else if (sort.key === 'status') {
            cmp = statusOrder[a.status] - statusOrder[b.status];
          } else if (sort.key === 'dt') {
            const t1 = (a.dt === '―') ? 0 : new Date(a.dt).getTime();
            const t2 = (b.dt === '―') ? 0 : new Date(b.dt).getTime();
            cmp = t1 - t2;
          } else {
            // grade, category, name は文字列比較
            cmp = a[sort.key].localeCompare(b[sort.key], 'ja');
          }
          return (sort.dir === 'asc' ? 1 : -1) * cmp;
        });
      }

      const tbody = document.querySelector('#tocTable tbody');
      tbody.innerHTML = '';
      data.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.grade}</td>
          <td>${item.category}</td>
          <td><a href="${item.file}" target="_blank">${item.name}</a></td>
          <td>${item.status}</td>
          <td>${item.dt}</td>
          <td>${item.hs}</td>
          <td>${item.clears}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ------------------------------------------------------------
    // 6) ページロード時に fetch → build → render → ソート設定 を実行
    // ------------------------------------------------------------
    let buildList = [];
    window.onload = async () => {
      const drills = await loadDrills();
      buildList = buildListFromDrills(drills);
      attachSortHandlers();
      renderTable();
    };
  </script>
</body>
</html>
