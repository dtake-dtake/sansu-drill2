<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>算数学習アプリ 目次</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      background: #e0f7fa;
    }
    h1, p {
      text-align: center;
      margin-bottom: 12px;
    }
    table {
      width: 100%;
      background: #fff;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      white-space: nowrap;
    }
    th {
      background: #f5f5f5;
      cursor: pointer;
    }
    a {
      color: inherit;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <h1>算数学習アプリ</h1>
  <p>以下のドリルを選んでください。</p>

  <table id="tocTable">
    <thead>
      <tr>
        <th data-key="grade">学年</th>
        <th data-key="category">カテゴリ</th>
        <th data-key="name">名前</th>
        <th data-key="status">ステータス</th>
        <th data-key="dt">最終チャレンジ</th>
        <th data-key="hs">ハイスコア</th>
        <th data-key="clears">クリア回数</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // ----------------------------------------------------------------------------
    // ●1) drills.json を読み込み、配列 buildList を組み立てる
    // ----------------------------------------------------------------------------
    async function loadDrills() {
      try {
        const resp = await fetch('data/drills.json');
        if (!resp.ok) throw new Error('drills.json の読み込みに失敗しました: ' + resp.status);
        return await resp.json();
      } catch (e) {
        console.error(e);
        return [];
      }
    }

    // ----------------------------------------------------------------------------
    // ●2) localStorage からハイスコア・履歴・クリア回数を取得して一覧用オブジェクトを生成
    // ----------------------------------------------------------------------------
    const statusOrder = { 'SS': 6, 'S': 5, 'A': 4, 'B': 3, 'C': 2, 'D': 1, '―': 0 };

    function buildListFromDrills(drills) {
      return drills.map(d => {
        // highScore
        const hs = localStorage.getItem(d.ns + 'highScore') || '―';
        // clearCount
        const clears = localStorage.getItem(d.ns + 'clearCount') || '0';
        // history から最新ステータス・日時
        let status = '―', dt = '―';
        try {
          const historyJSON = localStorage.getItem(d.ns + 'history') || '[]';
          const arr = JSON.parse(historyJSON);
          if (arr.length > 0) {
            status = arr[0].status || status;
            dt = arr[0].datetime || dt;
          }
        } catch { /* エラー時は初期値を保持 */ }
        return {
          grade:    d.grade,
          category: d.category,
          name:     d.name,
          file:     d.file,
          status,
          dt,
          hs,
          clears
        };
      });
    }

    // ----------------------------------------------------------------------------
    // ●3) ソートキー・向きの初期値
    // ----------------------------------------------------------------------------
    let sort = { key: 'name', dir: null };

    // ----------------------------------------------------------------------------
    // ●4) ソート用ヘッダクリックの設定
    // ----------------------------------------------------------------------------
    function attachSortHandlers() {
      document.querySelectorAll('th[data-key]').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.getAttribute('data-key');
          if (sort.key === key && sort.dir) {
            // 同じ列がクリックされたら昇順<->降順を切り替え
            sort.dir = (sort.dir === 'asc' ? 'desc' : 'asc');
          } else {
            // 別の列をクリックしたら、その列を降順でソート開始
            sort.key = key;
            sort.dir = 'desc';
          }
          renderTable();
        });
      });
    }

    // ----------------------------------------------------------------------------
    // ●5) テーブル描画：sort.dir === null のときはソートせず、そのまま buildList の順序を使う
    // ----------------------------------------------------------------------------
    function renderTable() {
      let data;
      if (sort.dir === null) {
        // 初期表示：JSON の並び順そのまま
        data = [...buildList];
      } else {
        // ソートが指定されている場合
        data = [...buildList].sort((a, b) => {
          let cmp = 0;
          if (sort.key === 'hs' || sort.key === 'clears') {
            // 数値として比較
            cmp = (+a[sort.key] || 0) - (+b[sort.key] || 0);
          } else if (sort.key === 'status') {
            // ステータスは事前に定義した順序で比較
            cmp = statusOrder[a.status] - statusOrder[b.status];
          } else if (sort.key === 'dt') {
            // 日付を比較。未履歴なら最小値として扱う
            const t1 = a.dt === '―' ? 0 : new Date(a.dt).getTime();
            const t2 = b.dt === '―' ? 0 : new Date(b.dt).getTime();
            cmp = t1 - t2;
          } else {
            // 文字列（学年・カテゴリ・名前）の場合
            cmp = a[sort.key].localeCompare(b[sort.key], 'ja');
          }
          return (sort.dir === 'asc' ? 1 : -1) * cmp;
        });
      }

      const tbody = document.querySelector('#tocTable tbody');
      tbody.innerHTML = '';
      data.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.grade}</td>
          <td>${item.category}</td>
          <td><a href="${item.file}" target="_blank">${item.name}</a></td>
          <td>${item.status}</td>
          <td>${item.dt}</td>
          <td>${item.hs}</td>
          <td>${item.clears}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ----------------------------------------------------------------------------
    // ●6) onload 時に fetch→ビルド→描画→ソートハンドラ設定 を実行
    // ----------------------------------------------------------------------------
    let buildList = [];
    window.onload = async () => {
      const drills = await loadDrills();
      buildList = buildListFromDrills(drills);
      attachSortHandlers();
      renderTable();
    };
  </script>
</body>
</html>
