<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>九九</title>
  <style>
    body { font-family: sans-serif; background: #b3ecff; margin: 20px; color: #333; font-size: 2rem; line-height: 1.5; }
    h1, h2 { text-align: center; margin: 10px 0; }
    h2 { font-size: 1.8rem; margin-bottom: 30px; }
    #problems-wrapper { max-width: 600px; margin: 0 auto 20px; padding: 20px; border: 2px solid #ccc; background: #fff; box-shadow: 3px 3px 6px rgba(0,0,0,.1); }
    .problem { display: flex; align-items: center; margin-bottom: 20px; }
    .problem-number { width: 60px; text-align: right; margin-right: 20px; font-weight: bold; font-size: 2rem; }
    .problem-equation { flex: 1; display: flex; align-items: center; font-size: 2rem; }
    .problem-equation span { margin: 0 10px; }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; width: 60px; font-size: 2rem; margin-left: 10px; padding: 5px; }
    .button-area { text-align: center; margin-bottom: 20px; }
    button { font-size: 2rem; margin: 0 10px; padding: 10px 20px; background: #f2f2f2; border: 1px solid #ccc; cursor: pointer; }
    button:hover { background: #e0e0e0; }
    button:disabled { background: #ddd; cursor: default; }
    #result-area { text-align: center; margin-bottom: 20px; }
    #result { font-size: 2rem; font-weight: bold; margin: 10px 0; }
    #highScoreArea, #clearCountArea, #monthlyCountArea { font-size: 1.8rem; margin: 10px 0; }
    #highScoreValue, #clearCountValue, #monthlyCountValue { font-weight: bold; margin: 0 10px; }
    #reset-highscore { font-size: 1.6rem; margin-left: 10px; padding: 6px 14px; }
    #history-area { font-size: 1.6rem; margin: 10px 0; }
    #history-list { list-style: none; padding: 0; margin: 0; }
    #history-list li { margin: 4px 0; }
    .result-icon { margin-left: 10px; font-size: 2rem; font-weight: bold; white-space: nowrap; }
    .correct { color: red; }
    .wrong { color: blue; }
    .status-stars { font-size: 2rem; }
    .status-SS { background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet); -webkit-background-clip: text; color: transparent; }
    .status-S  { color: gold; }
    .status-A, .status-B, .status-C, .status-D, .status-NA { color: black; }
  </style>
</head>
<body>
  <h1>けいさんドリル</h1>
  <h2>九九</h2>

  <div id="start-area" style="text-align:center; margin:40px 0;">
    <button id="start-btn">スタート</button>
  </div>

  <div id="main" style="display:none;">
    <div id="problems-wrapper"></div>
    <div class="button-area">
      <button id="check-answers">採点</button>
      <button id="retry">もういちど</button>
    </div>
    <div id="result-area">
      <div id="result"></div>
      <div id="highScoreArea">ハイスコア：<span id="highScoreValue">0</span><button id="reset-highscore">リセット</button></div>
      <div id="clearCountArea">クリア回数：<span id="clearCountValue">0</span></div>
      <div id="monthlyCountArea">今月のクリア回数：<span id="monthlyCountValue">0</span></div>
      <div id="history-area">履歴（最新10件）<br><ul id="history-list"></ul></div>
    </div>
  </div>

  <script>
    // メタデータ
    const APP_GRADE = '2';
    const APP_CATEGORY = '九九';
    const APP_NS = 'multiplication_1to9_v6_';
    const KEY_HS = APP_NS + 'highScore';
    const KEY_HISTORY = APP_NS + 'history';
    const KEY_CLEAR = APP_NS + 'clearCount';
    const KEY_MONTHLY_PREFIX = APP_NS + 'monthlyClear-';
    const currentMonth = new Date().toISOString().slice(0,7);

    // 設定
    const NUM_QUESTIONS = 10;
    const TIME_LIMIT = 60;

    // 状態変数
    let problems = [];
    let startTime = 0;
    let highScore = 0;
    let clearCount = 0;
    let monthlyCount = 0;

    // ユーティリティ
    const nowDT = () => new Date().toLocaleString();
    const statusOf = s =>
      s >= 150 ? 'SS' :
      s >= 120 ? 'S' :
      s >= 101 ? 'A' :
      s >= 90 ? 'B' :
      s >= 80 ? 'C' : 'D';
    const scrollCenter = el => el.scrollIntoView({behavior: 'smooth', block: 'center'});

    // localStorage 操作
    const ls = localStorage;
    function loadHighScore(){ const v = ls.getItem(KEY_HS); if(v) highScore = +v; }
    function saveHighScore(v){ ls.setItem(KEY_HS, String(v)); }
    function loadClearCount(){ const v = ls.getItem(KEY_CLEAR); if(v) clearCount = +v; }
    function saveClearCount(v){ ls.setItem(KEY_CLEAR, String(v)); }
    function loadHistory(){ try { return JSON.parse(ls.getItem(KEY_HISTORY))||[]; } catch { return []; } }
    function saveHistory(e){ const h = loadHistory(); h.unshift(e); if(h.length>10) h.pop(); ls.setItem(KEY_HISTORY, JSON.stringify(h)); renderHistory(h); }
    function loadMonthlyCount(){ const key = KEY_MONTHLY_PREFIX + currentMonth; const v = ls.getItem(key); monthlyCount = v ? +v : 0; }
    function saveMonthlyCount(v){ const key = KEY_MONTHLY_PREFIX + currentMonth; ls.setItem(key, String(v)); }

    // 画面更新
    function renderHistory(hist){ const ul = document.getElementById('history-list'); ul.innerHTML = ''; hist.forEach(x => { const li = document.createElement('li'); li.textContent = `${x.datetime}：${x.score}（${x.status}）`; ul.appendChild(li); }); }
    function updateHighScore(){ document.getElementById('highScoreValue').textContent = highScore; }
    function updateClearCount(){ document.getElementById('clearCountValue').textContent = clearCount; }
    function updateMonthlyCount(){ document.getElementById('monthlyCountValue').textContent = monthlyCount; }

    // 問題生成（全81問からランダム10問）
    function generateProblems(){
      const all = [];
      for(let a=1; a<=9; a++) for(let b=1; b<=9; b++) all.push({a, b});
      // Fisher–Yates シャッフル
      for(let i=all.length-1; i>0; i--){ const j = Math.floor(Math.random()*(i+1)); [all[i], all[j]] = [all[j], all[i]]; }
      problems = all.slice(0, NUM_QUESTIONS);
    }

    function displayProblems(){
      const wrap = document.getElementById('problems-wrapper'); wrap.innerHTML = '';
      problems.forEach((p, i) => {
        const row = document.createElement('div'); row.className = 'problem';
        const num = document.createElement('div'); num.className = 'problem-number'; num.textContent = (i+1) + '.';
        const eq = document.createElement('div'); eq.className = 'problem-equation';
        eq.innerHTML = `<span>${p.a}</span><span>×</span><span>${p.b}</span>=`;
        const inp = document.createElement('input'); inp.type = 'number'; inp.id = `ans-${i}`;
        inp.addEventListener('focus', () => scrollCenter(inp));
        inp.addEventListener('keydown', e => { if(e.key==='Enter'){ const nxt = document.getElementById(`ans-${i+1}`); if(nxt) nxt.focus(); else document.getElementById('check-answers').focus(); }});
        const icon = document.createElement('span'); icon.id = `icon-${i}`; icon.className = 'result-icon';
        eq.append(inp, icon);
        row.append(num, eq);
        wrap.appendChild(row);
      });
    }

    // 採点
    function disableInputs(){ document.querySelectorAll('input[type=number]').forEach(i=>i.disabled=true); }
    function enableInputs(){ document.querySelectorAll('input[type=number]').forEach(i=>i.disabled=false); }
    function checkAnswers(){
      document.getElementById('check-answers').disabled = true;
      let correct = 0;
      problems.forEach((p, i) => {
        const user = +document.getElementById(`ans-${i}`).value;
        const ans = p.a * p.b;
        const icon = document.getElementById(`icon-${i}`);
        icon.textContent = ''; icon.classList.remove('correct','wrong');
        if(user === ans){ correct++; icon.textContent='○'; icon.classList.add('correct'); }
        else { icon.textContent=`× (正解:${ans})`; icon.classList.add('wrong'); }
      });
      disableInputs();
      const elapsed = ((Date.now() - startTime)/1000).toFixed(1);
      const score = Math.floor(correct * 10 * (2 - Math.min(elapsed/TIME_LIMIT,1)));
      const status = statusOf(score);
      let stars='', cls='status-NA';
      switch(status){
        case 'SS': stars='★★★★★'; cls='status-SS'; break;
        case 'S':  stars='★★★★';  cls='status-S';  break;
        case 'A':  stars='★★★';   cls='status-A';  break;
        case 'B':  stars='★★';    cls='status-B';  break;
        case 'C':  stars='★';     cls='status-C';  break;
        case 'D':  stars='';      cls='status-D';  break;
      }
      document.getElementById('result').innerHTML =
        `スコア: <strong>${score}</strong><br>` +
        `正解数: ${correct}/${NUM_QUESTIONS}　時間: ${elapsed} 秒<br>` +
        `ステータス：<span class="status-stars ${cls}">${stars}</span>`;
      if(score > highScore){ highScore = score; saveHighScore(score); updateHighScore(); }
      saveHistory({datetime: nowDT(), score, status});
      if(correct === NUM_QUESTIONS){ clearCount++; saveClearCount(clearCount); updateClearCount(); monthlyCount++; saveMonthlyCount(monthlyCount); updateMonthlyCount(); }
      document.getElementById('retry').focus();
    }

    // 再挑戦
    function retry(){
      startTime = Date.now();
      document.getElementById('check-answers').disabled = false;
      generateProblems(); displayProblems(); enableInputs();
      document.getElementById('result').textContent = '';
      document.getElementById('ans-0').focus();
    }

    // ハイスコアリセット
    function resetAll(){ if(confirm('ハイスコアをリセットしますか？')){ highScore = 0; ls.removeItem(KEY_HS); updateHighScore(); }}

    window.addEventListener('DOMContentLoaded', () => {
      loadHighScore(); loadClearCount(); loadMonthlyCount();
      updateHighScore(); updateClearCount(); updateMonthlyCount();
      renderHistory(loadHistory());
      document.getElementById('check-answers').onclick = checkAnswers;
      document.getElementById('retry').onclick = retry;
      document.getElementById('reset-highscore').onclick = resetAll;
      const startBtn = document.getElementById('start-btn');
      startBtn.onclick = () => { document.getElementById('start-area').remove(); document.getElementById('main').style.display = ''; retry(); };
      document.addEventListener('keydown', e => { if(e.key === 'Enter') startBtn.click(); });
    });
  </script>
</body>
</html>
